
운영 체제를 업그레이드하건, 스프트웨어를 업데이트를 적용하거나 OS 업데이트를 제공하거나 es 또는 logstash, kibana 등의 버전을 업그레이드해야 한다.

이를 최대한 빠르고 효율적으로 진행하기 위해 이러한 작업을 수행하는 동안 인덱스 재할당을 비활성화 해야 한다.

클러스터에서 노드를 중지할 때마다  es는 이에 대응하여 자동으로 복구를 시도하고 샤드를 여기저기로 이동시키기 시작한다.

단순히 클러스터 전체에 소트프웨어 업그레이드를 적용하기 위해

롤링 재시작을 시도할 때 이러한 일이 발생하면 안 될 것이다.

작업하는 동안 아무것도 어키지 않도록 모든 것을 비활성화, 끄고 수행해야 할 것이다.

따라서 주어진 노드에서 작업하는 동안 해당 리밸런싱을 비활성화해야 한다.

## Rolling Restart Procedure

클러스터 전체에 걸쳐 유지보수를 위해 rolling restart  수행에서 따라야 할 절차는 다음과 같다.

1. 가능하다면 새로운 데이터의 인덱싱을 중지해야 한다.
2. es 클러스터에 대한 권한을 종료해야 한다.
3. 클러스터에서 샤드 할당을 비활성화해야 한다.
	1. 이는 노드가 다운되었을 때 문제가 발생해 모든 것을 재분배하려는 행위를 막는것이다. 대신 이를 비활성화할 것이다.
4. 운영 중인 도를 종료한다.
5. 필요한 유지보수를 수행한 후 필요하다면 재시작하고 클러스터에 다시 합류했는지 확인한다.
6. 그 시점에서 샤드 할당을 다시 활성화하여 정상 상태로 되돌린다.
7. 그러면 클러스터가 green status 로 전환되길 가다린다.
8. 완료되면 클러스터의 각 노드에 대해 필요한 업데이트를 적용하기 위해 하나씩 이러한 단계를 반복한다.
9. 이 시점부터는 클러스터 전체에 불일치 상태가 더 이상 없으므로 새 데이터 인덱싱을 재개할 수 있다.


- 샤드 할당 비활성화 명령어
~~~
PUT _cluster/settings
{
	"persistent": {
		"cluster.routing.allocation.enable": "primaries"
	}
}
~~~

- 전체 클러스터에서 es 종료
~~~
sudo /bin/systemctl stop elasticsearch.service
~~~

- 필요한 유지보수 수행 후 클러스터 재시작
	- 동일한 설정을 null 로 설정하여 샤드 할당을 다시 활성화한다.
~~~
PUT _cluster/settings
{
	"persistent": {
		"cluster.routing.allocation.enable": null
	}
}
~~~